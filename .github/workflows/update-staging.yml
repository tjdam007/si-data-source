name: Update Staging Remote Config

on:
  push:
    paths:
      - "awv2/**.meta.json"

jobs:
  update-staging:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find new meta.json files
        id: find-meta
        run: |
          META_FILES=$(git diff --name-only HEAD~1 HEAD -- 'awv2/*.meta.json' 2>/dev/null || echo "")
          if [ -z "$META_FILES" ]; then
            META_FILES=$(git log -1 --name-only --diff-filter=AM --pretty=format: -- 'awv2/*.meta.json')
          fi
          echo "files=$META_FILES" >> "$GITHUB_OUTPUT"
          echo "Found meta files: $META_FILES"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install google-auth-library
        run: npm install google-auth-library

      - name: Update Firebase Remote Config (Staging)
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          node << 'SCRIPT'
          const fs = require("fs");
          const { GoogleAuth } = require("google-auth-library");

          const PROJECT_ID = "anime-wallpaper-54b95";
          const RC_PARAM_KEY = "staging_wallpaper_data_source_v3";

          // Extract current value for a key, then DELETE it from everywhere in rcData
          function extractAndRemove(rcData, key) {
            let value = null;

            // Check top-level parameters
            if (rcData.parameters?.[key]) {
              value = rcData.parameters[key].defaultValue?.value || null;
              console.log(`  Found "${key}" in top-level parameters — removing`);
              delete rcData.parameters[key];
            }

            // Check ALL parameterGroups
            if (rcData.parameterGroups) {
              for (const [groupName, group] of Object.entries(rcData.parameterGroups)) {
                if (group.parameters?.[key]) {
                  if (!value) {
                    value = group.parameters[key].defaultValue?.value || null;
                  }
                  console.log(`  Found "${key}" in parameterGroup "${groupName}" — removing`);
                  delete group.parameters[key];

                  // If group is now empty, remove the group too
                  if (Object.keys(group.parameters).length === 0) {
                    delete rcData.parameterGroups[groupName];
                  }
                }
              }

              // If parameterGroups is now empty, remove it
              if (Object.keys(rcData.parameterGroups).length === 0) {
                delete rcData.parameterGroups;
              }
            }

            return value;
          }

          async function main() {
            const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);

            const auth = new GoogleAuth({
              credentials: serviceAccount,
              scopes: ["https://www.googleapis.com/auth/firebase.remoteconfig"],
            });
            const client = await auth.getClient();
            const tokenRes = await client.getAccessToken();
            const accessToken = tokenRes.token;

            const rcUrl = `https://firebaseremoteconfig.googleapis.com/v1/projects/${PROJECT_ID}/remoteConfig`;

            // 1. GET current Remote Config
            const getRes = await fetch(rcUrl, {
              headers: {
                Authorization: `Bearer ${accessToken}`,
                Accept: "application/json",
              },
            });

            if (!getRes.ok) {
              throw new Error(`GET Remote Config failed: ${getRes.status} ${await getRes.text()}`);
            }

            const etag = getRes.headers.get("etag");
            const rcData = await getRes.json();

            // Debug: log structure
            console.log("Top-level parameter keys:", Object.keys(rcData.parameters || {}));
            if (rcData.parameterGroups) {
              for (const [name, group] of Object.entries(rcData.parameterGroups)) {
                console.log(`ParameterGroup "${name}" keys:`, Object.keys(group.parameters || {}));
              }
            }

            // 2. Extract current value and remove key from ALL locations
            const currentValue = extractAndRemove(rcData, RC_PARAM_KEY);
            let dataSource;
            if (currentValue) {
              dataSource = JSON.parse(currentValue);
            } else {
              dataSource = { version: 1, data: [] };
            }

            // 3. Read meta.json files and append new packs
            const gitFiles = `${{ steps.find-meta.outputs.files }}`.split("\n").filter(Boolean);
            const allFiles = [...new Set(gitFiles)];

            for (const filePath of allFiles) {
              if (!filePath || !fs.existsSync(filePath)) continue;

              const meta = JSON.parse(fs.readFileSync(filePath, "utf8"));
              console.log(`Processing: ${meta.pack_name} (${meta.total} wallpapers)`);

              const existingIndex = dataSource.data.findIndex(
                (p) => p.pack_name === meta.pack_name
              );
              if (existingIndex >= 0) {
                console.log(`  Replacing existing pack: ${meta.pack_name}`);
                dataSource.data[existingIndex] = meta;
              } else {
                console.log(`  Appending new pack: ${meta.pack_name}`);
                dataSource.data.push(meta);
              }
            }

            // 4. Add key back in ONE place only (top-level parameters)
            if (!rcData.parameters) rcData.parameters = {};
            rcData.parameters[RC_PARAM_KEY] = {
              defaultValue: { value: JSON.stringify(dataSource) },
            };

            const putRes = await fetch(rcUrl, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json; UTF-8",
                "If-Match": etag,
              },
              body: JSON.stringify(rcData),
            });

            if (!putRes.ok) {
              throw new Error(`PUT Remote Config failed: ${putRes.status} ${await putRes.text()}`);
            }

            console.log("Staging Remote Config updated successfully!");
            console.log(`Total packs: ${dataSource.data.length}`);
          }

          main().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          SCRIPT
